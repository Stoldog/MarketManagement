<div class="row">
    <div class="col-md-12">
        <div class="col-md-8">
            <div class="box box-danger">
                <div class="box-header">
                    商品信息
                </div>
                <div class="box-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <th>
                                <input type="checkbox" id="checkAll"/>
                            </th>
                            <th>
                                <button class="btn btn-link" title="商品流水号" data-toggle="tooltip" data-placement="top" style="color: #333333;font-weight: bold;font-family:微软雅黑;">
                                    商品流水号
                                </button>
                            </th>
                            <th>
                                <button class="btn btn-link" title="商品名称" data-toggle="tooltip" data-placement="top" style="color: #333333;font-weight: bold;font-family:微软雅黑;">
                                    商品名称
                                </button>
                            </th>
                            <th>
                                <button class="btn btn-link" title="销售价" data-toggle="tooltip" data-placement="top" style="color: #333333;font-weight: bold;font-family:微软雅黑;">
                                    销售单价
                                </button>
                            </th>
                            <th>
                                <button class="btn btn-link" title="库存" data-toggle="tooltip" data-placement="top" style="color: #333333;font-weight: bold;font-family:微软雅黑;">
                                    库存
                                </button>
                            </th>
                            <th>
                                <button class="btn btn-link" title="商品数量" data-toggle="tooltip" data-placement="top" style="color: #333333;font-weight: bold;font-family:微软雅黑;">
                                    商品数量
                                </button>
                            </th>
                            <th>
                                <button class="btn btn-link" title="商品名称" data-toggle="tooltip" data-placement="top" style="color: #333333;font-weight: bold;font-family:微软雅黑;">
                                    总金额
                                </button>
                            </th>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="box-footer">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>总计(元):</label>
                            <input type="number" min="0" class="form-control" readonly="readonly" value="0" id="totalProduct">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>实收(元):</label>
                            <input type="number" min="0" class="form-control" readonly="readonly" value="0" id="realGet">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>应找(元):</label>
                            <input type="number" min="0" value="0" class="form-control" readonly="readonly" id="realGive">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>总数量:</label>
                            <input type="number" min="0" class="form-control" readonly="readonly" value="0" id="totalProductNum">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="col-md-12">
                <div class="box box-danger">
                    <div class="box-body">
                        <div class="col-md-12 form-group">
                            <label>商品流水号:</label>
                            <input type="text" class="form-control" list="sellList" id="sellPNO"/>
                            <datalist id="sellList">

                            </datalist>
                        </div>
                        <div class="col-md-12 form-group">
                            <label>商品数量:</label>
                            <input type="number" class="form-control" id="sellPNum"/>
                        </div>
                        <div class="col-md-12 form-group">
                            <button onclick="getProductInfo()" class="btn btn-info">添加</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="box box-danger">
                    <div class="box-body">
                        <div class="col-md-12">
                            <label>收银:</label>
                            <input class="form-control" onkeyup="calMoney(this)" type="text" id="realPrice"/>
                        </div>
                        <div class="col-md-12">
                            <button onclick="sellProduct()" class="btn btn-danger">结清</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    $(function () {
        //发送请求获得商品列表
        $.ajax("/repertory/getRepertoryKeyValue",{
            method:"GET",
            contentType:"application/json; charset=UTF-8",
            success:function (res) {
                console.log(res);
                //删除之前节点
                $(res.list).each(function () {
                    $("#sellList").append("<option value='"+this.productSerialNo+"'  label='"+this.productName+"'></option>");
                });
            }
        });
    });

    function getProductInfo() {
        //获得商品流水号
        var sellPNO=$("#sellPNO").val();
        var sellPNum=$("#sellPNum").val();
        if(sellPNum==""){
            alertWarning("商品数量不能为空！");
            return;
        }
        var total=$("#totalProduct").val();
        var totalProductNum=$("#totalProductNum").val();
        //发送请求获得商品列表
        $.ajax("/repertory/getRepertoryBySerial/"+sellPNO,{
            method:"GET",
            contentType:"application/json; charset=UTF-8",
            success:function (res) {
                console.log(res);
                //限制商品最大input
                $("#sellPNum").prop("max",res.list.productNum);
                //将商品信息放入表格 并计算总价
                $(res.list).each(function () {
                    var dataTemp={
                        "productId":this.productId,
                        "productMarketPrice":this.marketPrice,
                        "sellNum":parseInt(sellPNum),
                        "productTotalPrice":sellPNum*this.marketPrice,
                        "productSerialNo":this.productSerialNo
                    };
                   $('tbody').append("<tr><td><input type='checkbox' checked='true' value='"+JSON.stringify(dataTemp)+"'/></td><td>"+this.productSerialNo+"</td><td>"+this.productName+"</td><td>"+this.marketPrice+"元</td><td>"+this.productNum+this.productUnit+"</td><td>"+sellPNum+this.productUnit+"</td><td>"+(sellPNum*this.marketPrice)+"元</td></tr>");
                });
                var priceA=parseInt(total)+(res.list[0].marketPrice*sellPNum);
                var totalNumA=parseInt(totalProductNum)+parseInt(sellPNum);
                $("#totalProduct").val(priceA);
                $("#totalProductNum").val(totalNumA);

                console.log(priceA);
            }
        });
    }
    function calMoney(getMoney) {
        //console.log($(getMoney).val());
        var gmoney=$(getMoney).val();
        var tmoney=$("#totalProduct").val();
        $("#realGet").val(gmoney);
        $("#realGive").val((gmoney-tmoney).toFixed(1));
        if(gmoney==0){
            $("#realGive").val(0);
        }
    }
    function calTotal(getTotalNum) {
        var gmo=$(getTotalNum).val();
        var tmoney=$("#totalProduct").val();
        $("#realGet").val(gmoney);
        $("#realGive").val((gmoney-tmoney).toFixed(1));
        if(gmoney==0){
            $("#realGive").val(0);
        }
    }
    function sellProduct() {
        var realTotal=$("#totalProduct").val();
        var date=new Date().getTime();
        var totalNum=$("#totalProductNum").val();
        var obj=[];
        //获得所有checkbox下的
        $("tbody tr").find("input").each(function () {
            if($(this).prop("checked")){
                obj.push(JSON.parse($(this).val()));
            }
        });
        console.log(obj);
        console.log(realTotal);
        //发送请求卖出货物
        $.ajax("/sell/sellProduct/"+date+"/"+realTotal+"/"+totalNum,{
            method:"POST",
            data:JSON.stringify(obj),
            contentType:"application/json; charset=UTF-8",
            success:function (res) {
                console.log(res);
                $("#contentBody").load(baseUrl+"/market/pages/sellManagement/selling.html");
            }
        });
    }
</script>